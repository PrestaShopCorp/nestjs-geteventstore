<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>nestjs-geteventstore documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="./images/favicon.ico">
	    <link rel="stylesheet" href="./styles/style.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="./" class="navbar-brand">nestjs-geteventstore documentation</a>
            <button type="button" class="btn btn-default btn-menu fa fa-bars" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
            <div id="book-search-input" role="search">
                <input type="text" placeholder="Type to search">
            </div>
            <nav>
            
                <ul class="list">
            
                    <li class="title">
                        <a href="./">nestjs-geteventstore documentation</a>
                    </li>
            
                    <li class="divider"></li>
            
            
                    <li class="chapter">
                        <a data-type="chapter-link" href="./"><span class="fa fa-home"></span>Getting started</a>
                        <ul class="links">
                                <li class="link">
                                    <a href="./"  class="active" ><span class="fa fa-file-text-o"></span>README</a>
                                </li>
                                <li class="link">
                                    <a  href="./overview.html" 
                                        
                                         href="./overview.html" 
                                        
                                        >
                                        <span class="fa fa-th"></span>Overview
                                    </a>
                                </li>
                        </ul>
                    </li>
            
            
            
            
                    <li class="chapter">
                        <div class="simple">
                            <span class="fa fa-file-code-o"></span>
                            <span>Classes</span>
                            <span class="menu-toggler fa fa-angle-up" data-toggle="collapse"
                                    data-target="#xs-classes-links"
                                ></span>
                        </div>
                        <ul class="links collapse in"
                                id="xs-classes-links"
                            >
                                <li class="link">
                                    <a href="classes/AcknowledgeableEventStoreEvent.html" >AcknowledgeableEventStoreEvent</a>
                                </li>
                                <li class="link">
                                    <a href="classes/DropAncientItemCommand.html" >DropAncientItemCommand</a>
                                </li>
                                <li class="link">
                                    <a href="classes/EventStore.html" >EventStore</a>
                                </li>
                                <li class="link">
                                    <a href="classes/EventStoreAggregateRoot.html" >EventStoreAggregateRoot</a>
                                </li>
                                <li class="link">
                                    <a href="classes/EventStoreBusHealthIndicator.html" >EventStoreSubscriptionHealthIndicator</a>
                                </li>
                                <li class="link">
                                    <a href="classes/EventStoreEvent.html" >EventStoreEvent</a>
                                </li>
                                <li class="link">
                                    <a href="classes/EventStoreHealthIndicator.html" >EventStoreHealthIndicator</a>
                                </li>
                                <li class="link">
                                    <a href="classes/EventStoreObserverHealthIndicator.html" >EventStoreObserverHealthIndicator</a>
                                </li>
                                <li class="link">
                                    <a href="classes/GetHeroesQuery.html" >GetHeroesQuery</a>
                                </li>
                                <li class="link">
                                    <a href="classes/Hero.html" >Hero</a>
                                </li>
                                <li class="link">
                                    <a href="classes/HeroDamagedEnemyEvent.html" >HeroDamagedEnemyEvent</a>
                                </li>
                                <li class="link">
                                    <a href="classes/HeroDropItemEvent.html" >HeroDropItemEvent</a>
                                </li>
                                <li class="link">
                                    <a href="classes/HeroFoundItemEvent.html" >HeroFoundItemEvent</a>
                                </li>
                                <li class="link">
                                    <a href="classes/HeroKilledDragonEvent.html" >HeroKilledDragonEvent</a>
                                </li>
                                <li class="link">
                                    <a href="classes/KillDragonCommand.html" >KillDragonCommand</a>
                                </li>
                        </ul>
                    </li>
            
            
                    <li class="chapter">
                        <div class="simple">
                            <span class="fa fa-long-arrow-down"></span>
                            <span>Injectables</span>
                            <span class="menu-toggler fa fa-angle-up" data-toggle="collapse"
                                    data-target="#xs-injectables-links"
                                ></span>
                        </div>
                        <ul class="links collapse in"
                                id="xs-injectables-links"
                            >
                                <li class="link">
                                    <a href="injectables/EventStoreBus.html" >EventStoreBus</a>
                                </li>
                                <li class="link">
                                    <a href="injectables/EventStoreInterceptor.html" >EventStoreInterceptor</a>
                                </li>
                                <li class="link">
                                    <a href="injectables/EventStoreObserver.html" >EventStoreObserver</a>
                                </li>
                                <li class="link">
                                    <a href="injectables/EventStorePublisher.html" >EventStorePublisher</a>
                                </li>
                                <li class="link">
                                    <a href="injectables/HeroRepository.html" >HeroRepository</a>
                                </li>
                                <li class="link">
                                    <a href="injectables/HeroesGameSagas.html" >HeroesGameSagas</a>
                                </li>
                        </ul>
                    </li>
            
                    <li class="chapter">
                        <div class="simple">
                            <span class="fa fa-info"></span>
                            <span>Interfaces</span>
                            <span class="menu-toggler fa fa-angle-up" data-toggle="collapse"
                                    data-target="#xs-interfaces-links"
                                ></span>
                        </div>
                        <ul class="links collapse in"
                                id="xs-interfaces-links"
                            >
                                <li class="link">
                                    <a href="interfaces/Constructor.html" >Constructor</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/IAcknowledgeableEvent.html" >IAcknowledgeableEvent</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/IAggregateEvent.html" >IAggregateEvent</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/IEventStoreBusConfig.html" >IEventStoreBusConfig</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/IEventStoreConfig.html" >IEventStoreConfig</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/IEventStoreEventOptions.html" >IEventStoreEventOptions</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/IExpectedVersionEvent.html" >IExpectedVersionEvent</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/IHttpEndpoint.html" >IHttpEndpoint</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/IStreamConfig.html" >IStreamConfig</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/IStreamMetadata.html" >IStreamMetadata</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/ISubscriptionStatus.html" >ISubscriptionStatus</a>
                                </li>
                                <li class="link">
                                    <a href="interfaces/KillDragonDto.html" >KillDragonDto</a>
                                </li>
                        </ul>
                    </li>
            
            
                    <li class="chapter">
                        <a data-type="chapter-link" href="./miscellaneous.html" ><span class="fa fa-cubes"></span>Miscellaneous</a>
                    </li>
            
                    <li class="chapter">
                        <a data-type="chapter-link" href="./coverage.html" ><span class="fa fa-tasks"></span>Documentation coverage</a>
                    </li>
            
                    <li class="divider"></li>
                    <li class="copyright">
                            Documentation generated using <a href="https://compodoc.github.io/compodoc/" target="_blank">
                                        <img src=".//images/compodoc-vectorise.svg" class="img-responsive">
                            </a>
                    </li>
            
                </ul>
            
            </nav>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <nav>
                   
                       <ul class="list">
                   
                           <li class="title">
                               <a href="./">nestjs-geteventstore documentation</a>
                           </li>
                   
                           <li class="divider"></li>
                   
                               <div id="book-search-input" role="search">
                                   <input type="text" placeholder="Type to search">
                               </div>
                   
                           <li class="chapter">
                               <a data-type="chapter-link" href="./"><span class="fa fa-home"></span>Getting started</a>
                               <ul class="links">
                                       <li class="link">
                                           <a href="./"  class="active" ><span class="fa fa-file-text-o"></span>README</a>
                                       </li>
                                       <li class="link">
                                           <a  href="./overview.html" 
                                               
                                                href="./overview.html" 
                                               
                                               >
                                               <span class="fa fa-th"></span>Overview
                                           </a>
                                       </li>
                               </ul>
                           </li>
                   
                   
                   
                   
                           <li class="chapter">
                               <div class="simple">
                                   <span class="fa fa-file-code-o"></span>
                                   <span>Classes</span>
                                   <span class="menu-toggler fa fa-angle-up" data-toggle="collapse"
                                           data-target="#classes-links"
                   ></span>
                               </div>
                               <ul class="links collapse in"
                                       id="classes-links"
                   >
                                       <li class="link">
                                           <a href="classes/AcknowledgeableEventStoreEvent.html" >AcknowledgeableEventStoreEvent</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/DropAncientItemCommand.html" >DropAncientItemCommand</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/EventStore.html" >EventStore</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/EventStoreAggregateRoot.html" >EventStoreAggregateRoot</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/EventStoreBusHealthIndicator.html" >EventStoreSubscriptionHealthIndicator</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/EventStoreEvent.html" >EventStoreEvent</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/EventStoreHealthIndicator.html" >EventStoreHealthIndicator</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/EventStoreObserverHealthIndicator.html" >EventStoreObserverHealthIndicator</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/GetHeroesQuery.html" >GetHeroesQuery</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/Hero.html" >Hero</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/HeroDamagedEnemyEvent.html" >HeroDamagedEnemyEvent</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/HeroDropItemEvent.html" >HeroDropItemEvent</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/HeroFoundItemEvent.html" >HeroFoundItemEvent</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/HeroKilledDragonEvent.html" >HeroKilledDragonEvent</a>
                                       </li>
                                       <li class="link">
                                           <a href="classes/KillDragonCommand.html" >KillDragonCommand</a>
                                       </li>
                               </ul>
                           </li>
                   
                   
                           <li class="chapter">
                               <div class="simple">
                                   <span class="fa fa-long-arrow-down"></span>
                                   <span>Injectables</span>
                                   <span class="menu-toggler fa fa-angle-up" data-toggle="collapse"
                                           data-target="#injectables-links"
                   ></span>
                               </div>
                               <ul class="links collapse in"
                                       id="injectables-links"
                   >
                                       <li class="link">
                                           <a href="injectables/EventStoreBus.html" >EventStoreBus</a>
                                       </li>
                                       <li class="link">
                                           <a href="injectables/EventStoreInterceptor.html" >EventStoreInterceptor</a>
                                       </li>
                                       <li class="link">
                                           <a href="injectables/EventStoreObserver.html" >EventStoreObserver</a>
                                       </li>
                                       <li class="link">
                                           <a href="injectables/EventStorePublisher.html" >EventStorePublisher</a>
                                       </li>
                                       <li class="link">
                                           <a href="injectables/HeroRepository.html" >HeroRepository</a>
                                       </li>
                                       <li class="link">
                                           <a href="injectables/HeroesGameSagas.html" >HeroesGameSagas</a>
                                       </li>
                               </ul>
                           </li>
                   
                           <li class="chapter">
                               <div class="simple">
                                   <span class="fa fa-info"></span>
                                   <span>Interfaces</span>
                                   <span class="menu-toggler fa fa-angle-up" data-toggle="collapse"
                                           data-target="#interfaces-links"
                   ></span>
                               </div>
                               <ul class="links collapse in"
                                       id="interfaces-links"
                   >
                                       <li class="link">
                                           <a href="interfaces/Constructor.html" >Constructor</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/IAcknowledgeableEvent.html" >IAcknowledgeableEvent</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/IAggregateEvent.html" >IAggregateEvent</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/IEventStoreBusConfig.html" >IEventStoreBusConfig</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/IEventStoreConfig.html" >IEventStoreConfig</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/IEventStoreEventOptions.html" >IEventStoreEventOptions</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/IExpectedVersionEvent.html" >IExpectedVersionEvent</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/IHttpEndpoint.html" >IHttpEndpoint</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/IStreamConfig.html" >IStreamConfig</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/IStreamMetadata.html" >IStreamMetadata</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/ISubscriptionStatus.html" >ISubscriptionStatus</a>
                                       </li>
                                       <li class="link">
                                           <a href="interfaces/KillDragonDto.html" >KillDragonDto</a>
                                       </li>
                               </ul>
                           </li>
                   
                   
                           <li class="chapter">
                               <a data-type="chapter-link" href="./miscellaneous.html" ><span class="fa fa-cubes"></span>Miscellaneous</a>
                           </li>
                   
                           <li class="chapter">
                               <a data-type="chapter-link" href="./coverage.html" ><span class="fa fa-tasks"></span>Documentation coverage</a>
                           </li>
                   
                           <li class="divider"></li>
                           <li class="copyright">
                                   Documentation generated using <a href="https://compodoc.github.io/compodoc/" target="_blank">
                                               <img src=".//images/compodoc-vectorise.svg" class="img-responsive">
                                   </a>
                           </li>
                   
                       </ul>
                   
                   </nav>
               </div>
               <div class="content readme">
                   <div class="content-data">
<h1 id="nestjs-eventstore">nestjs-eventstore</h1>
<p>Event store driven NestJS and CQRS</p>
<p>example is from official Nest JS example</p>
<p><code>`</code>shell script<br>docker run -p 22113: -p 11113: -d -n eventstore eventstore/eventstore<br>yarn<br>cd examples<br>yarn<br>yarn start</p>
<pre><code class="hljs undefined"><br># Eventstore config<br><br>```typescript<br>@Module({<br>  imports: [<br>    EventStoreModule.registerAsync(<br>      {<br>        credentials: {<br>          username: process.env.EVENTSTORE_CREDENTIALS_USERNAME || 'admin',<br>          password: process.env.EVENTSTORE_CREDENTIALS_PASSWORD || 'changeit',<br>        },<br>        tcp: {<br>          host: process.env.EVENTSTORE_TCP_HOST || 'localhost',<br>          port: +process.env.EVENTSTORE_TCP_PORT || 1113,<br>        },<br>        http: {<br>          host: process.env.EVENTSTORE_HTTP_HOST || 'http://localhost',<br>          port: +process.env.EVENTSTORE_HTTP_PORT || 2113,<br>        },<br>        tcpConnectionName: 'connection-hero-event-handler-and-saga',<br>        onTcpConnected: () => {<br>        },<br>        onTcpDisconnected: () => {<br>        },<br>      },<br>    ),<br>  ],<br>  controllers: [],<br>  providers: [],<br>})<br>export class AppModule {}<br></code></pre><h1 id="cqrs">CQRS</h1>
<h2 id="events">Events</h2>
<p>Basic one </p>
<pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> HeroKilledDragonEvent <span class="hljs-keyword">implements</span> IEvent{<br>  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><br>    <span class="hljs-keyword">public</span> readonly data: {<br>      heroId: <span class="hljs-built_in">string</span>,<br>      dragonId: <span class="hljs-built_in">string</span><br>    }</span>) {<br>  }<br>}</code></pre><p>Basic one with options (event id, ...) </p>
<pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> HeroKilledDragonEvent <span class="hljs-keyword">extends</span> EventStoreEvent {<br>  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><br>    <span class="hljs-keyword">public</span> readonly data: {<br>      heroId: <span class="hljs-built_in">string</span>,<br>      dragonId: <span class="hljs-built_in">string</span><br>    }, options?</span>) {<br>    <span class="hljs-keyword">super</span>(data, options);<br>  }<br>}</code></pre><p>Acknowledgeable and with a custom stream</p>
<pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> HeroKilledDragonEvent <br>  <span class="hljs-keyword">extends</span> AcknowledgeableEventStoreEvent {<br>  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><br>    <span class="hljs-keyword">public</span> readonly data: {<br>      heroId: <span class="hljs-built_in">string</span>,<br>      dragonId: <span class="hljs-built_in">string</span><br>    }, options?</span>) {<br>    <span class="hljs-keyword">super</span>(data, options);<br>  }<br><br>  <span class="hljs-keyword">get</span> eventStreamId() {<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">`hero-<span class="hljs-subst">${<span class="hljs-keyword">this</span>.data.heroId}</span>`</span>;<br>  }<br><br>}</code></pre><h2 id="aggregate-root">Aggregate root</h2>
<pre><code class="hljs typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> Hero                   <br>  <span class="hljs-comment">// Change from base cqrs</span><br>  <span class="hljs-keyword">extends</span> EventStoreAggregateRoot {<br>  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> id</span>) {<br>    <span class="hljs-keyword">super</span>();<br>    <span class="hljs-comment">// Where your events are gonna be stored by default</span><br>    <span class="hljs-keyword">this</span>.streamConfig = {<br>      streamName: <span class="hljs-string">`hero-<span class="hljs-subst">${id}</span>`</span><br>    } <span class="hljs-keyword">as</span> IStreamConfig;<br>  }<br>}</code></pre><h2 id="command-handling">Command handling</h2>
<pre><code class="hljs typescript"><span class="hljs-meta">@CommandHandler</span>(DropAncientItemCommand)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> DropAncientItemHandler<br>  <span class="hljs-keyword">implements</span> ICommandHandler&lt;DropAncientItemCommand&gt; {<br>  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><br>    <span class="hljs-keyword">private</span> readonly repository: HeroRepository,<br>    <span class="hljs-comment">// Only change from base CQRS</span><br>    <span class="hljs-keyword">private</span> readonly publisher: EventStorePublisher,<br>  </span>) {}<br><br>  <span class="hljs-keyword">async</span> execute(command: DropAncientItemCommand) {<br>    <span class="hljs-built_in">console</span>.log(clc.yellowBright(<span class="hljs-string">'Async DropAncientItemCommand...'</span>));<br><br>    <span class="hljs-keyword">const</span> { heroId, itemId } = command;<br>    <span class="hljs-keyword">const</span> hero = <span class="hljs-keyword">this</span>.publisher.mergeObjectContext(<br>      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.repository.findOneById(+heroId),<br>    );<br>    hero.addItem(itemId);<br>    hero.dropItem(itemId);<br><br>    hero.commit();<br>  }<br>}</code></pre><h2 id="idempotency">Idempotency</h2>
<h3 id="using-event-id">Using event id</h3>
<p>Eventstore keep in memory a few million id and deduplicate on this<br>means a reboot you don&#39;t have idempotency</p>
<p>Add a custom eventId in your event <code></code> </p>
<h3 id="using-expectedversion">Using expectedVersion</h3>
<p>Guaranty idempotency even after restart<br>Guaranty events order</p>
<p>Bonus define in eventStore the retention rules and stream access rules</p>
<p>Bonus start transaction on a handler, continue it some where else (alpha)</p>
<pre><code class="hljs typescript"><span class="hljs-meta">@CommandHandler</span>(KillDragonCommand)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> KillDragonHandler <span class="hljs-keyword">implements</span> ICommandHandler&lt;KillDragonCommand&gt; {<br>  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><br>    <span class="hljs-keyword">private</span> readonly repository: HeroRepository,<br>    <span class="hljs-comment">// Needed </span><br>    <span class="hljs-keyword">private</span> readonly publisher: EventStorePublisher,<br>  </span>) {<br>  }<br><br>  <span class="hljs-keyword">async</span> execute(command: KillDragonCommand) {<br>    <span class="hljs-keyword">const</span> { heroId, dragonId } = command;<br>    <span class="hljs-keyword">const</span> hero = <span class="hljs-keyword">this</span>.publisher.mergeObjectContext(<br>      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.repository.findOneById(+heroId),<br>    );<br>    <span class="hljs-comment">// Use custom stream only for this process</span><br>    <span class="hljs-keyword">await</span> hero.setStreamConfig({<br>      <span class="hljs-comment">// all next events will have this stream</span><br>      streamName: <span class="hljs-string">`hero_fight-<span class="hljs-subst">${heroId}</span>`</span>,<br>      <span class="hljs-comment">// Error if the stream is not new when writing</span><br>      <span class="hljs-comment">// You can set your custom order by using this attribute in event</span><br>      expectedVersion: ExpectedVersion.NoStream,<br><br>      <span class="hljs-comment">// Set retention rules for this new stream</span><br>      metadata: {<br>        <span class="hljs-comment">// stream is deleted (needs scavenge to be run)</span><br>        $maxAge: <span class="hljs-number">2</span> * DAY,<br>        <span class="hljs-comment">// store only the last x events in the stream</span><br>        $maxCount: <span class="hljs-number">5</span>,<br>      },<br><br>      (TO FINISH)<br>      <span class="hljs-comment">// id of the transaction to start</span><br>      transaction: <span class="hljs-keyword">await</span> publisher.startTransaction()<br>      <span class="hljs-comment">// Or continue from</span><br>      transaction: <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.publisher.continueTransaction(transaction.id)<br>    });<br>    hero.damageEnemy(dragonId, <span class="hljs-number">2</span>);<br>    hero.damageEnemy(dragonId, <span class="hljs-number">-8</span>);<br><br>    <span class="hljs-comment">//Write and dispatch events</span><br>    hero.commit();<br><br>    <span class="hljs-comment">// Change stream for next events</span><br>    <span class="hljs-keyword">await</span> hero.setStreamConfig({<br>      streamName: <span class="hljs-string">`hero-<span class="hljs-subst">${heroId}</span>`</span>,<br>      <span class="hljs-comment">// It must be a new stream</span><br>      expectedVersion: ExpectedVersion.NoStream,<br>    });<br>    hero.killEnemy(dragonId);<br>    hero.commit();<br>  }<br>}</code></pre><h2 id="saga">Saga</h2>
<p>Identical to default implementation</p>
<pre><code class="hljs typescript"><span class="hljs-meta">@Saga</span>()<br>dragonKilled = (events$: Observable&lt;<span class="hljs-built_in">any</span>&gt;): Observable&lt;ICommand&gt; =&gt; {<br><span class="hljs-keyword">return</span> events$<br>  .pipe(<br>    filter(<span class="hljs-function"><span class="hljs-params">ev</span> =&gt;</span> ev <span class="hljs-keyword">instanceof</span> HeroKilledDragonEvent),<br>    delay(<span class="hljs-number">400</span>),<br>    map(<span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {<br>      <span class="hljs-built_in">console</span>.log(clc.redBright(<span class="hljs-string">'Inside [HeroesGameSagas] Saga after a little sleep'</span>));<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DropAncientItemCommand(event.data.heroId, itemId);<br>    }),<br>  );<br>}</code></pre><h2 id="eventhandler">EventHandler</h2>
<p>Identical with nest cqrs if your want.</p>
<p>You win <code>ack()</code> and <code>nack()</code> if your event extends <code>AcknowledgeableEventStoreEvent</code><br>(only for persistent subscriptions)</p>
<p>Nack strategies are available</p>
<pre><code class="hljs typescript"><span class="hljs-meta">@EventsHandler</span>(HeroKilledDragonEvent)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> HeroKilledDragonHandler<br>  <span class="hljs-keyword">implements</span> IEventHandler&lt;HeroKilledDragonEvent&gt; {<br>  <span class="hljs-keyword">async</span> handle(event: HeroKilledDragonEvent) {<br>    <span class="hljs-built_in">console</span>.log(clc.greenBright(<span class="hljs-string">'HeroKilledDragonEventHandler...'</span>));<br>    <span class="hljs-keyword">await</span> event.ack();<br>  }<br>}</code></pre><h2 id="subscription">Subscription</h2>
<p>Sends eventstore events to saga and event handler</p>
<p>Configured from your module config, you can manage multiple tcp subscriptions or catchup in parrallel<br>in the same bus</p>
<p>Persistent : </p>
<ul>
<li>realtime   </li>
<li>you can ack, nack and </li>
<li>you have a pointer in your event stack.  </li>
<li>dedicated interface in eventstore is also available  </li>
</ul>
<p>Catchup : </p>
<ul>
<li>to start you must tell where you are in the event stack</li>
<li>continue to wait for realtime</li>
</ul>
<pre><code class="hljs typescript"><span class="hljs-meta">@Module</span>({<br>  imports: [<br>    TerminusModule,<br>    EventStoreCqrsModule.registerAsync(<br>      {<br>        credentials: {<br>          username: process.env.EVENTSTORE_CREDENTIALS_USERNAME || <span class="hljs-string">'admin'</span>,<br>          password: process.env.EVENTSTORE_CREDENTIALS_PASSWORD || <span class="hljs-string">'changeit'</span>,<br>        },<br>        tcp: {<br>          host: process.env.EVENTSTORE_TCP_HOST || <span class="hljs-string">'localhost'</span>,<br>          port: +process.env.EVENTSTORE_TCP_PORT || <span class="hljs-number">11113</span>,<br>        },<br>        http: {<br>          host: process.env.EVENTSTORE_HTTP_HOST || <span class="hljs-string">'http://localhost'</span>,<br>          port: +process.env.EVENTSTORE_HTTP_PORT || <span class="hljs-number">22113</span>,<br>        },<br>        tcpConnectionName: <span class="hljs-string">'connection-hero-event-handler-and-saga'</span>,<br>        onTcpConnected: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<br>        },<br>        onTcpDisconnected: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {<br>        },<br>      },<br>      {<br>        <span class="hljs-comment">// Where you map event store incoming event to your format</span><br>        eventMapper: <span class="hljs-function">(<span class="hljs-params">data, options: IEventStoreEventOptions</span>) =&gt;</span> {<br>          <span class="hljs-keyword">let</span> className = <span class="hljs-string">`<span class="hljs-subst">${options.eventType}</span>`</span>;<br>          Logger.debug(<br>            <span class="hljs-string">`Build <span class="hljs-subst">${className}</span> received from stream <span class="hljs-subst">${options.eventStreamId}</span> with id <span class="hljs-subst">${options.eventId}</span>`</span>,<br>          );<br>          <span class="hljs-keyword">if</span> (!heroesEvents[className]) {<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>          }<br>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> heroesEvents[className](data, options);<br>        },<br>        subscriptions: {<br>          persistent: [<br>            {<br>              <span class="hljs-comment">// Event stream category (before the -)</span><br>              stream: <span class="hljs-string">'$ce-hero'</span>,<br>              group: <span class="hljs-string">'data'</span>,<br>              autoAck: <span class="hljs-literal">false</span>,<br>              bufferSize: <span class="hljs-number">1</span>,<br>              <span class="hljs-comment">// Subscription is created with this options</span><br>              options: {<br>                resolveLinkTos: <span class="hljs-literal">true</span>,<br>                minCheckPointCount: <span class="hljs-number">1</span>,<br>              },<br>              onSubscriptionStart: <span class="hljs-function">(<span class="hljs-params">subscription</span>) =&gt;</span> {<br>              },<br>              onSubscriptionDropped: <span class="hljs-function">(<span class="hljs-params">subscription</span>) =&gt;</span> {<br>              },<br>            },<br>          ],<br>        },<br>      },<br>    ),<br>  ],<br>  controllers: [],<br>  providers: [],<br>})<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> AppModule {<br>}</code></pre><h2 id="projections">Projections</h2>
<p>You can code your eventstore projection&#39;s in javascript in the project  </p>
<p>Using projection config and the js file<br>it asserts that projection exist and run during your app&#39;s boot. </p>
<p>With a projection you can route event to emit new events to another stream.<br>you can also send linkTo to do symlink like  </p>
<p><a href="https://eventstore.com/docs/getting-started/projections/index.html">https://eventstore.com/docs/getting-started/projections/index.html</a><br><a href="https://eventstore.com/docs/projections/user-defined-projections/index.html">https://eventstore.com/docs/projections/user-defined-projections/index.html</a></p>
<pre><code class="hljs javascript">fromCategory(<span class="hljs-string">'hero'</span>)<br><span class="hljs-comment">// One state per id (hero-541)</span><br>.foreachStream()<br>.when({<br>    <span class="hljs-comment">// Set default state when start</span><br>    <span class="hljs-attr">$init</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<br>        <span class="hljs-keyword">return</span> {<br>            <span class="hljs-attr">count</span>: <span class="hljs-number">0</span><br>        }<br>    },<br>    <span class="hljs-comment">// When event is received</span><br>    <span class="hljs-attr">ItemAddedEvent</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">s,e</span>)</span>{<br>        s.count += <span class="hljs-number">1</span>;<br>    }<br>})</code></pre><h2 id="terminus-health">Terminus health</h2>
<p>Give status send 503 on your <code>HealthController</code></p>
<pre><code class="hljs typescript"><span class="hljs-meta">@Controller</span>(<span class="hljs-string">'health'</span>)<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> HealthController {<br>  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><br>    <span class="hljs-keyword">private</span> health: HealthCheckService,<br>    <span class="hljs-keyword">private</span> eventStoreHealthIndicator: EventStoreHealthIndicator,<br>    <span class="hljs-keyword">private</span> eventStoreBusHealthIndicator: EventStoreSubscriptionHealthIndicator,<br>  </span>) {<br>  }<br><br>  <span class="hljs-meta">@Get</span>()<br>  <span class="hljs-meta">@HealthCheck</span>()<br>  healthCheck() {<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.health.check([<br>      <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">this</span>.eventStoreHealthIndicator.check(),<br>      <span class="hljs-keyword">async</span> () =&gt; <span class="hljs-keyword">this</span>.eventStoreBusHealthIndicator.check(),<br>    ]);<br>  }<br>}</code></pre><h2 id="errorinterceptor">ErrorInterceptor</h2>
<p>// TODO subscribe to eventbus subject to send error to any tools </p>
<h2 id="query-bus">Query bus</h2>
<p>// TODO code to query the state in the projection<br>// TO create new query to eventstore ?</p>
<h2 id="local-buffering">Local Buffering</h2>
<p>// TODO : adapt to tcp client and onConnected<br>// Work with http client and eventstore observer</p>
<h1 id="http-grpc-">HTTP/GRPC/...</h1>
<p>It can also be used without CQRS </p>
<h3 id="using-it-as-an-interceptor">Using it as an interceptor</h3>
<p>With this syntax all the output of your services are sent to eventstore</p>
<p>By default only last event will be sent back to http.  </p>
<pre><code class="hljs typescript"><span class="hljs-meta">@UseInterceptors</span>(EventStoreInterceptor)<br><span class="hljs-meta">@Controller</span>()<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> MyController {<br>    <span class="hljs-meta">@Post</span>(<span class="hljs-string">'/test'</span>)<br>    postMyRoute(<br>      <span class="hljs-meta">@Body</span>() body: MyDTO,<br>    ): Observable {<br>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.myService.doThisAction(body);<br>    }<br>}</code></pre><h3 id="using-it-in-a-queue-or-custom-script">Using it in a queue or custom script</h3>
<pre><code class="hljs typescript"><span class="hljs-meta">@Injectable</span>()<br><span class="hljs-meta">@Processor</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> MyQueue  {<br>  <span class="hljs-keyword">constructor</span>(<span class="hljs-params"><br>    <span class="hljs-meta">@Inject</span>(EVENT_STORE_OBSERVER_TOKEN)<br>    <span class="hljs-keyword">private</span> readonly eventStoreOberver: EventStoreObserver,<br>    <span class="hljs-keyword">private</span> readonly myService: myService,<br>  </span>) {<br>  }<br>  <span class="hljs-meta">@Process</span>(<span class="hljs-string">'superJob'</span>)<br>  <span class="hljs-keyword">async</span> superbJob(job: Job&lt;WithDataDto&gt;) {<br>    <span class="hljs-keyword">const</span> dispatcher$ = <span class="hljs-keyword">new</span> Subject();<br>    dispatcher$.subscribe(<span class="hljs-keyword">this</span>.eventStoreOberver);<br><br>    <span class="hljs-keyword">this</span>.myService.doThis(job.data)<br>      .subscribe(dispatcher$);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> dispatcher$.toPromise();<br>  }<br>}</code></pre>











                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
           </div>
       </div>

       <script src="./js/libs/bootstrap-native.js"></script>

       <script src="./js/libs/es6-shim.min.js"></script>
       <script src="./js/libs/EventDispatcher.js"></script>
       <script src="./js/libs/promise.min.js"></script>
       <script src="./js/libs/zepto.min.js"></script>

       <script src="./js/compodoc.js"></script>

       <script src="./js/search/search.js"></script>
       <script src="./js/search/lunr.min.js"></script>
       <script src="./js/search/search-lunr.js"></script>

       <script src="./js/menu.js"></script>
       <script src="./js/libs/highlight.pack.js"></script>
       <script src="./js/libs/highlightjs-line-numbers.min.js"></script>
       <script src="./js/search/search_index.js"></script>
       <script>
            document.addEventListener('DOMContentLoaded', function() {
                hljs.initHighlightingOnLoad();
                hljs.initLineNumbersOnLoad();
            });
       </script>

    </body>
</html>
